@page "/Meus-eventos"

@using ES2Real.Components.Layout
@using System.Net.Http.Json
@rendermode InteractiveServer
@inject HttpClient Http

<h3>Meus Eventos</h3>

<BackButton />

<div class="mb-3 d-flex gap-2 flex-wrap">
    <input class="form-control" placeholder="Filtrar por Categoria" @bind="FiltroCategoria" @bind:event="oninput" />
    <input class="form-control" placeholder="Filtrar por Local" @bind="FiltroLocal" @bind:event="oninput" />
    <input class="form-control" type="date" @bind="FiltroData" />
</div>

<div class="mt-4">
    <table class="table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Data</th>
                <th>Local</th>
                <th>Categoria</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in eventosFiltrados)
            {
                <tr>
                    <td>@e.Evento.Nome</td>
                    <td>@e.Evento.Data.ToString("dd/MM/yyyy")</td>
                    <td>@e.Evento.Local</td>
                    <td>@e.Evento.Categoria</td>
                    <td>
                        <button class="btn btn-danger" @onclick="() => CancelarInscricao(e.IdBilhete)">Cancelar Inscrição</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private List<BilheteParticipanteEventoDto> eventos = new();
    private List<BilheteParticipanteEventoDto> eventosFiltrados = new();

    private string filtroCategoria = string.Empty;
    private string filtroLocal = string.Empty;
    private DateTime? filtroData = null;

    protected override async Task OnInitializedAsync()
    {
        await CarregarEventos();
    }

    private async Task CarregarEventos()
    {
        try
        {
            eventos = await Http.GetFromJsonAsync<List<BilheteParticipanteEventoDto>>("api/BilheteParticipante");
            FiltrarEventos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar eventos: {ex.Message}");
        }
    }

    private void FiltrarEventos()
    {
        eventosFiltrados = eventos
            .Where(e =>
                (string.IsNullOrWhiteSpace(filtroCategoria) || e.Evento.Categoria.Contains(filtroCategoria, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrWhiteSpace(filtroLocal) || e.Evento.Local.Contains(filtroLocal, StringComparison.OrdinalIgnoreCase)) &&
                (!filtroData.HasValue || e.Evento.Data.Date == filtroData.Value.Date)
            )
            .ToList();
    }

    private async Task CancelarInscricao(int idBilhete)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/BilheteParticipante/cancelar/{idBilhete}");
            if (response.IsSuccessStatusCode)
            {
                await CarregarEventos();
            }
            else
            {
                Console.WriteLine($"Erro ao cancelar inscrição: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro: {ex.Message}");
        }
    }

    private string FiltroCategoria
    {
        get => filtroCategoria;
        set
        {
            filtroCategoria = value;
            FiltrarEventos();
        }
    }

    private string FiltroLocal
    {
        get => filtroLocal;
        set
        {
            filtroLocal = value;
            FiltrarEventos();
        }
    }

    private DateTime? FiltroData
    {
        get => filtroData;
        set
        {
            filtroData = value;
            FiltrarEventos();
        }
    }

    public class BilheteParticipanteEventoDto
    {
        public int IdBilhete { get; set; }
        public Evento Evento { get; set; } = new();
    }
}
